<?xml version="1.0" encoding="utf-8"?>
<!--

    Copyright (C) 2020 Cetmix OÃœ

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU LESSER GENERAL PUBLIC LICENSE as
    published by the Free Software Foundation, either version 3 of the
    License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU LESSER GENERAL PUBLIC LICENSE for more details.

    You should have received a copy of the GNU LESSER GENERAL PUBLIC LICENSE
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<odoo>
    <!--################
        # Conversation #
        ################-->
    <!--## Actions ##-->
    <record id="action_conversations" model="ir.actions.act_window">
        <field name="name">Conversations</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">cetmix.conversation</field>
        <field name="view_mode">tree,form</field>
    </record>
    <!--## Tree ##-->
    <record id="cetmix_conversation_tree" model="ir.ui.view">
        <field name="name">cetmix.conversation.tree</field>
        <field name="model">cetmix.conversation</field>
        <field name="arch" type="xml">
            <tree decoration-bf="message_needaction==True" js_class="mail_conversation_tree">
                <field invisible="1" name="message_needaction"/>
                <field name="subject_display" string="Conversation"/>
            </tree></field>
    </record>
    <!--## Form ##-->
    <record id="cetmix_conversation_form" model="ir.ui.view">
        <field name="name">cetmix.conversation.form</field>
        <field name="model">cetmix.conversation</field>
        <field name="arch" type="xml">
            <form string="Conversation">
                <header>
                    <button class="btn-primary" confirm="Are you sure?" icon="fa-sign-in" invisible="is_participant == True" name="join" string="Join" type="object"/>
                    <button class="btn-primary" confirm="Are you sure?" icon="fa-sign-out" invisible="is_participant == False" name="leave" string="Leave" type="object"/>
                    <button confirm="Conversation will be deleted after messages are moved! Are you sure?" icon="fa-arrow-right" name="%(prt_mail_messages.conversation_move_multi)d" string="Move Messages" type="action"/>
                    <button confirm="Are you sure?" icon="fa-archive" invisible="active == False" name="action_archive" string="Archive" type="object"/>
                    <button confirm="Are you sure?" icon="fa-archive" invisible="active == True" name="action_unarchive" string="Unarchive" type="object"/>
                </header>
                <sheet class="custom_sheet">
                    <div class="alert alert-info alert-dismissible fade show text-center" colspan="2" name="caption" role="alert">
                        Posted messages will be sent to all participants
                        <br/>
                        If all messages are moved or deleted from Conversation it
                        will be deleted
                    </div>
                    <div class="oe_title">
                        <h1>
                            <field name="name" placeholder="Subject..."/>
                        </h1>
                        <field invisible="1" name="active"/>
                        <field invisible="1" name="is_participant"/>
                    </div>
                    <group>
                        <field name="author_id" readonly="1" string="Started by"/>
                    </group>
                    <group string="Participants"/>
                    <field mode="kanban" name="partner_ids" options="{'not_delete': True, 'quick_create': False, 'create': True, 'delete': True}">
                        <kanban>
                            <field name="id"/>
                            <field name="color"/>
                            <field name="name"/>
                            <field name="title"/>
                            <field name="email"/>
                            <field name="function"/>
                            <field name="phone"/>
                            <field name="mobile"/>
                            <field name="avatar_128"/>
                            <templates>
                                <t t-name="kanban-box">
                                    <t t-set="color" t-value="kanban_color(record.color.raw_value)"/>
                                    <div t-att-class="color + (record.title.raw_value == 1 ? ' oe_kanban_color_alert' : '') + ' oe_kanban_global_click'">
                                        <div class="o_kanban_image">
                                            <img alt="Contact image" t-att-src="kanban_image('res.partner', 'avatar_128', record.id.raw_value)"/>
                                        </div>
                                        <div class="oe_kanban_details">
                                            <field name="name"/>
                                            <div class="float-end" name="presence_absent_active">
                                                <a aria-label="Leave Participant" class="fa fa-times pull-right text-danger" role="img" t-if="!read_only_mode" title="Leave Participant" type="delete"/>
                                            </div>
                                            <div t-if="record.function.raw_value">
                                                <field name="function"/>
                                            </div>
                                            <div t-if="record.email.raw_value">
                                                <field name="email" widget="email"/>
                                            </div>
                                            <div t-if="record.phone.raw_value">
                                                Phone:
                                                <t t-esc="record.phone.value"/>
                                            </div>
                                            <div t-if="record.mobile.raw_value">
                                                Mobile:
                                                <t t-esc="record.mobile.value"/>
                                            </div>
                                        </div>
                                    </div>
                                </t>
                            </templates>
                        </kanban></field>
                </sheet>
                <div class="oe_chatter">
                    <field name="message_ids"/>
                </div>
            </form></field>
    </record>
    <!--## Search ##-->
    <record id="cetmix_conversation_search" model="ir.ui.view">
        <field name="name">cetmix.conversation.search</field>
        <field name="model">cetmix.conversation</field>
        <field name="arch" type="xml">
            <search string="Conversation">
                <field name="name"/>
                <field name="author_id"/>
                <field name="last_message_by"/>
                <field name="partner_ids"/>
                <filter domain="[('message_needaction','=',True)]" name="message_needaction" string="Unread Messages"/>
                <separator/>
                <filter domain="[('partner_ids', 'in', [uid])]" name="participate" string="I participate"/>
                <separator/>
                <filter domain="[('active', '=', False)]" name="archived" string="Archived"/>
                <group string="Group By">
                    <filter context="{'group_by':'author_id'}" domain="[]" name="groupby_author" string="Author"/>
                    <separator/>
                    <filter context="{'group_by':'last_message_post'}" domain="[]" name="groupby_lastmessage" string="Last Message"/>
                </group>
            </search></field>
    </record>
    <!--## Menu ##-->
    <menuitem action="action_conversations" groups="group_conversation_own" id="menu_conversations" name="Conversations" parent="prt_messages_root" sequence="1"/>
</odoo>
